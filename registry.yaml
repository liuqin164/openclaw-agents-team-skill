version: 1.0.1
type: workflow-registry
name: artifact-driven-dev-team

description: >
  Artifact-driven virtual software development team workflow.
  Defines agent orchestration, scheduling rules, and automatic project folder creation hooks.

# =========================
# 1. Stagesï¼ˆé˜¶æ®µå®šä¹‰ï¼‰
# =========================
stages:
  - name: Planning
    order: 1

  - name: Design
    order: 2

  - name: Implementation
    order: 3

  - name: QA
    order: 4

# =========================
# 2. Agentsï¼ˆå‚ä¸è§’è‰²ï¼‰
# =========================
agents:
  - name: PM
    stage: Planning
    enabled: true

  - name: PJM
    stage: Planning
    enabled: true

  - name: UXDesigner
    stage: Design
    enabled: true

  - name: UIDesigner
    stage: Design
    enabled: true

  - name: Architect
    stage: Design
    enabled: true

  - name: BackendEngineer
    stage: Implementation
    enabled: true

  - name: FrontendEngineer
    stage: Implementation
    enabled: true

  - name: QA
    stage: QA
    enabled: true

# =========================
# 3. Triggersï¼ˆè§¦å‘è§„åˆ™ï¼‰
# =========================
triggers:
  # ---- Planning ----
  - agent: PM
    when:
      artifact_created: RawIdea
      # è‡ªåŠ¨åˆ›å»ºé¡¹ç›®æ–‡ä»¶å¤¹
      hooks:
        - create_project_folder_before_prd

  - agent: PJM
    when:
      artifact_approved: PRD

  # ---- Design ----
  - agent: UXDesigner
    when:
      artifact_approved: PRD

  - agent: UIDesigner
    when:
      artifact_approved: UserFlow

  - agent: Architect
    when:
      all:
        - artifact_approved: PRD
        - artifact_approved: UserFlow

  # ---- Implementation ----
  - agent: BackendEngineer
    when:
      artifact_approved: APISpec

  - agent: FrontendEngineer
    when:
      all:
        - artifact_approved: APISpec
        - artifact_approved: UIDesignSpec

  # ---- QA ----
  - agent: QA
    when:
      all:
        - artifact_completed: BackendImplementation
        - artifact_completed: FrontendImplementation

  # ---- Change Request Flow ----
  - agent: PM
    when:
      artifact_created: ChangeRequest
      hooks:
        - evaluate_change_request

# =========================
# 4. Stage Gatesï¼ˆé˜¶æ®µé—¨ç¦ï¼‰
# =========================
stage_gates:
  Planning:
    must_have:
      - PRD.approved
      - Backlog.approved

  Design:
    must_have:
      - UserFlow.approved
      - UIDesignSpec.approved
      - APISpec.approved

  Implementation:
    must_have:
      - BackendImplementation.completed
      - FrontendImplementation.completed

  QA:
    must_have:
      - TestReport.approved

# =========================
# 5. Parallelismï¼ˆå¹¶è¡Œç­–ç•¥ï¼‰
# =========================
parallelism:
  allowed:
    - UXDesigner
    - Architect

  blocked:
    - QA

# =========================
# 6. Failure & Rollback Policy
# =========================
failure_policy:
  on_artifact_rejected:
    action: rollback
    rollback_to: artifact.producer

  on_bug_reported:
    action: reopen
    require:
      - fix_artifact
      - regression_test

  # ---- Change Request Guard ----
  on_change_request_approved:
    rule:
      - forbid_direct_prd_edit
      - require_new_prd_version

# =========================
# 7. Completion Rule
# =========================
completion:
  when:
    artifact_approved: TestReport

# =========================
# 8. Custom Hooksï¼ˆè‡ªå®šä¹‰è§¦å‘ Hookï¼‰
# =========================
hooks:
  create_project_folder_before_prd:
    description: >
      åœ¨ PM æ”¶åˆ° RawIdea å¹¶å‡†å¤‡ç”Ÿæˆ PRD å‰ï¼Œ
      è‡ªåŠ¨åˆ›å»ºé¡¹ç›®ç›®å½•ï¼Œå¹¶ç”Ÿæˆ README.md å’Œæ“ä½œæ—¥å¿—ã€‚
    action: |
      import os, pathlib, re
      from datetime import datetime

      workspace = os.environ.get("OPENCLAW_WORKSPACE", "~/openclaw_workspace")
      workspace = os.path.expanduser(workspace)

      project_name = input_artifacts.get("RawIdea", {}).get("title", "default_project")
      safe_title = re.sub(r'[\\/:*?"<>| ]', '_', project_name.strip())
      base_folder_name = f"project-{safe_title}"
      project_path = os.path.join(workspace, base_folder_name)

      counter = 1
      final_path = project_path
      while os.path.exists(final_path):
          counter += 1
          final_path = f"{project_path}-{counter}"

      pathlib.Path(final_path).mkdir(parents=True, exist_ok=True)

      readme_path = os.path.join(final_path, "README.md")
      prd_file_name = "project_prd.md"
      with open(readme_path, "w", encoding="utf-8") as f:
          f.write(f"# é¡¹ç›®ç›®å½•: {base_folder_name}\n")
          f.write(f"- åŸå§‹éœ€æ±‚æ ‡é¢˜: {project_name}\n")
          f.write(f"- åˆ›å»ºæ—¶é—´: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}\n\n")
          f.write("## PRD æ–‡ä»¶\n")
          f.write(f"- å ä½ç¬¦: [{prd_file_name}]({prd_file_name})\n")
          f.write("- ç”Ÿæˆåè¯·æ›¿æ¢æ­¤å ä½ç¬¦ä¸ºå®é™…æ–‡ä»¶è·¯å¾„\n")

      log_file = os.path.join(workspace, "project_creation.log")
      with open(log_file, "a", encoding="utf-8") as log:
          log.write(f"{datetime.now().strftime('%Y-%m-%d %H:%M:%S')} | åˆ›å»ºé¡¹ç›®æ–‡ä»¶å¤¹: {final_path}\n")

      print(f"âœ… é¡¹ç›®æ–‡ä»¶å¤¹å·²åˆ›å»º: {final_path}")
      print(f"ğŸ“„ README.md å·²ç”Ÿæˆï¼ŒåŒ…å« PRD å ä½ç¬¦")

  evaluate_change_request:
    description: >
      å½“ PM æ”¶åˆ° ChangeRequest æ—¶ï¼Œè‡ªåŠ¨è¯„ä¼°å˜æ›´å½±å“ï¼Œå¹¶å†³å®šç”Ÿæˆå°ç‰ˆæœ¬ PRD æˆ–ä¸»ç‰ˆæœ¬ PRDã€‚
    action: |
      # ä¼ªä»£ç ç¤ºä¾‹
      print("ğŸ”„ ChangeRequest è‡ªåŠ¨è¯„ä¼°æµç¨‹è§¦å‘")
      # å¯è°ƒç”¨ PM Agent é€»è¾‘ç”Ÿæˆæ–° PRD ç‰ˆæœ¬
