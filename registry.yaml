version: 1.1.0
type: workflow-registry
name: artifact-driven-dev-team

description: >
  Artifact-driven virtual software development team workflow.
  Defines stage ownership, artifact-driven progression,
  and prevents pipeline interruption.

# =========================
# 1. Stagesï¼ˆé˜¶æ®µå®šä¹‰ + Ownerï¼‰
# =========================
stages:
  - name: Planning
    order: 1
    owner: PM
    completion_condition:
      - PRD.approved
      - Backlog.approved

  - name: Design
    order: 2
    owner: Architect
    completion_condition:
      - UserFlow.approved
      - UIDesignSpec.approved
      - APISpec.approved

  - name: Implementation
    order: 3
    owner: BackendEngineer
    completion_condition:
      - BackendImplementation.completed
      - FrontendImplementation.completed

  - name: QA
    order: 4
    owner: QA
    completion_condition:
      - TestReport.approved

# =========================
# 2. Agentsï¼ˆå‚ä¸Žè§’è‰²ï¼‰
# =========================
agents:
  - name: PM
    stage: Planning
    enabled: true

  - name: PJM
    stage: Planning
    enabled: true

  - name: UXDesigner
    stage: Design
    enabled: true

  - name: UIDesigner
    stage: Design
    enabled: true

  - name: Architect
    stage: Design
    enabled: true

  - name: BackendEngineer
    stage: Implementation
    enabled: true

  - name: FrontendEngineer
    stage: Implementation
    enabled: true

  - name: QA
    stage: QA
    enabled: true

# =========================
# 3. Triggersï¼ˆArtifact é©±åŠ¨ï¼‰
# =========================
triggers:

  # ---- Planning ----
  - agent: PM
    when:
      artifact_created: RawIdea
    hooks:
      - before_prd_create

  - agent: PJM
    when:
      artifact_approved: PRD

  # ---- Design ----
  - agent: UXDesigner
    when:
      artifact_approved: PRD

  - agent: UIDesigner
    when:
      artifact_approved: UserFlow

  - agent: Architect
    when:
      all:
        - artifact_approved: PRD
        - artifact_approved: UserFlow

  # ---- Implementation ----
  - agent: BackendEngineer
    when:
      artifact_approved: APISpec

  - agent: FrontendEngineer
    when:
      all:
        - artifact_approved: APISpec
        - artifact_approved: UIDesignSpec

  # ---- QA ----
  - agent: QA
    when:
      stage_completed: Implementation

  # ---- Change Request ----
  - agent: PM
    when:
      artifact_created: ChangeRequest
    hooks:
      - evaluate_change_request

# =========================
# 4. Stage Transitionï¼ˆé˜¶æ®µæŽ¨è¿›è§„åˆ™ï¼‰
# =========================
stage_transition:
  - from: Planning
    to: Design
    when: stage_completed

  - from: Design
    to: Implementation
    when: stage_completed

  - from: Implementation
    to: QA
    when: stage_completed

# =========================
# 5. Parallelismï¼ˆå¹¶è¡Œç­–ç•¥ï¼‰
# =========================
parallelism:
  allowed:
    - UXDesigner
    - Architect

  blocked:
    - QA

# =========================
# 6. Failure & Rollback Policy
# =========================
failure_policy:
  on_artifact_rejected:
    action: rollback_stage
    rollback_to_stage_owner: true

  on_bug_reported:
    action: reopen_stage
    target_stage: Implementation

# =========================
# 7. Skill Keepaliveï¼ˆé˜²æ­¢â€œè‡ªåŠ¨é€€åŒ–â€ï¼‰
# =========================
keepalive:
  mode: artifact-driven
  refresh_on:
    - artifact_created
    - artifact_approved
    - artifact_completed
  heartbeat_log: true

# =========================
# 8. Hooksï¼ˆç”Ÿå‘½å‘¨æœŸ Hookï¼‰
# =========================
hooks:

  before_prd_create:
    description: >
      Create project folder and register project_path
      before PRD generation.
    action: |
      import os, pathlib, re
      from datetime import datetime

      workspace = os.path.expanduser(
        os.environ.get("OPENCLAW_WORKSPACE", "~/openclaw_workspace")
      )

      raw = input_artifacts.get("RawIdea", {})
      project_name = raw.get("title", "default_project")
      safe = re.sub(r'[^a-zA-Z0-9_]', '_', project_name)

      base = f"project-{safe}"
      path = os.path.join(workspace, base)
      i = 1
      final = path
      while os.path.exists(final):
          i += 1
          final = f"{path}-{i}"

      pathlib.Path(final).mkdir(parents=True, exist_ok=True)

      context["project_path"] = final
      context["project_name"] = safe

      with open(os.path.join(final, "README.md"), "w", encoding="utf-8") as f:
          f.write(f"# {safe}\n\n")
          f.write("PRD: project_prd.md\n")

      print(f"ðŸ“ Project initialized at {final}")

  evaluate_change_request:
    description: >
      Evaluate ChangeRequest and decide PRD versioning strategy.
    action: |
      print("ðŸ”„ ChangeRequest evaluation triggered")
