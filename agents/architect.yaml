agent: Architect
role: System Architect
stage: Design

input:
  - PRD
  - UserFlow

output:
  - APISpec
  - DBSchema

prompt: |
  ä½ æ˜¯ä¸€åç³»ç»Ÿæ¶æ„å¸ˆã€‚
  ä½ çš„èŒè´£æ˜¯å®šä¹‰ç³»ç»Ÿçš„æŠ€æœ¯ç»“æ„ï¼Œå¹¶è¾“å‡º API æ¥å£æ–‡æ¡£å’Œæ•°æ®åº“ Schemaã€‚

  æ‰€æœ‰æ¥å£å¿…é¡»æ¸…æ™°ã€ç¨³å®šã€å¯ä¾›å‰åç«¯ç›´æ¥ä½¿ç”¨ã€‚

  æ³¨æ„ï¼š
  - APISpec å’Œ DBSchema æ–‡ä»¶å¿…é¡»å†™å…¥ PM åˆ›å»ºçš„é¡¹ç›®ç›®å½•
  - è‡ªåŠ¨è¯†åˆ«é¡¹ç›®ç›®å½•ï¼ˆæ”¯æŒå¸¦åºå·çš„é¡¹ç›®è·¯å¾„ï¼‰
  - è‡ªåŠ¨è®°å½•ç”Ÿæˆæ—¥å¿—
  - ä¿æŒä¸ PRD / UserFlow ç‰ˆæœ¬ä¸€è‡´çš„ç›®å½•å’Œå‘½åè§„åˆ™

rules:
  - ä¸å®ç°ä»»ä½•ä»£ç 
  - ä¸ä¿®æ”¹éœ€æ±‚å®šä¹‰
  - API è®¾è®¡éœ€ä¿æŒå‰åç«¯ä¸€è‡´æ€§

constraints:
  - output_format: markdown

hooks:
  after_stage:
    - name: generate_architect_files
      description: >
        åœ¨ Architect æ ¹æ® PRD å’Œ UserFlow ç”Ÿæˆ APISpec å’Œ DBSchema åï¼Œ
        å°†æ–‡ä»¶å†™å…¥é¡¹ç›®ç›®å½•ï¼Œå¹¶è®°å½•æ—¥å¿—
      action: |
        import os
        import re
        from datetime import datetime

        workspace = os.environ.get("OPENCLAW_WORKSPACE", "~/openclaw_workspace")
        workspace = os.path.expanduser(workspace)

        # è·å–é¡¹ç›®åç§°
        prd_meta = input_artifacts.get("PRD", {}).get("meta", {})
        project_name = prd_meta.get("Project Name", None)
        if not project_name:
            project_name = "default_project"

        safe_title = re.sub(r'[\\/:*?"<>| ]', '_', project_name.strip())
        base_folder_name = f"project-{safe_title}"
        project_path = os.path.join(workspace, base_folder_name)

        # æ”¯æŒå¸¦åºå·çš„é¡¹ç›®è·¯å¾„
        counter = 1
        final_path = project_path
        while not os.path.exists(final_path):
            counter += 1
            final_path = f"{project_path}-{counter}"

        # å†™ APISpec
        apispec_content = output_artifacts.get("APISpec", {}).get("content", "")
        apispec_file_name = "project_apispec.md"
        apispec_file_path = os.path.join(final_path, apispec_file_name)
        with open(apispec_file_path, "w", encoding="utf-8") as f:
            f.write(apispec_content)

        # å†™ DBSchema
        dbschema_content = output_artifacts.get("DBSchema", {}).get("content", "")
        dbschema_file_name = "project_dbschema.md"
        dbschema_file_path = os.path.join(final_path, dbschema_file_name)
        with open(dbschema_file_path, "w", encoding="utf-8") as f:
            f.write(dbschema_content)

        # å†™æ—¥å¿—
        log_file = os.path.join(workspace, "project_creation.log")
        with open(log_file, "a", encoding="utf-8") as log:
            log.write(f"{datetime.now().strftime('%Y-%m-%d %H:%M:%S')} | APISpec å·²ç”Ÿæˆ: {apispec_file_path}\n")
            log.write(f"{datetime.now().strftime('%Y-%m-%d %H:%M:%S')} | DBSchema å·²ç”Ÿæˆ: {dbschema_file_path}\n")

        print(f"ğŸ“„ APISpec æ–‡ä»¶å·²ç”Ÿæˆ: {apispec_file_path}")
        print(f"ğŸ“„ DBSchema æ–‡ä»¶å·²ç”Ÿæˆ: {dbschema_file_path}")
