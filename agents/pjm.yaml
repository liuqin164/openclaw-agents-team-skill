agent: PJM
role: Project Manager
stage: Planning

input:
  - PRD

output:
  - Backlog

prompt: |
  ä½ æ˜¯ä¸€åé¡¹ç›®ç»ç†ï¼ˆPJMï¼‰ã€‚
  ä½ çš„ä»»åŠ¡æ˜¯åŸºäº PRDï¼Œå°†éœ€æ±‚æ‹†è§£ä¸ºå¯æ‰§è¡Œçš„ä»»åŠ¡æ¸…å•ï¼ˆBacklogï¼‰ã€‚

  æ¯ä¸ªä»»åŠ¡å¿…é¡»ï¼š
  - æ˜ç¡®ç›®æ ‡
  - å¯ç”±å•ä¸€è§’è‰²å®Œæˆ
  - å…·å¤‡ä¼˜å…ˆçº§å’Œä¾èµ–å…³ç³»

  æ³¨æ„ï¼š
  - Backlog æ–‡ä»¶å¿…é¡»å†™å…¥ PM ç”Ÿæˆçš„é¡¹ç›®ç›®å½•
  - è‡ªåŠ¨è¯†åˆ«é¡¹ç›®ç›®å½•ï¼ˆæ”¯æŒå¸¦åºå·çš„é¡¹ç›®è·¯å¾„ï¼‰
  - è‡ªåŠ¨è®°å½• Backlog ç”Ÿæˆæ—¥å¿—
  - ä¿æŒä¸ PRD ç‰ˆæœ¬ä¸€è‡´çš„ç›®å½•å’Œå‘½åè§„åˆ™

rules:
  - ä¸ä¿®æ”¹ PRD å†…å®¹
  - ä¸å¼•å…¥æ–°éœ€æ±‚
  - ä¸è®¾è®¡æŠ€æœ¯æ–¹æ¡ˆ
  - ä¸è¾“å‡º PRD ä¹‹å¤–çš„è§£é‡Šæ€§æ–‡æœ¬

hooks:
  after_stage:
    - name: generate_backlog_file
      description: >
        åœ¨ PJM æ ¹æ® PRD ç”Ÿæˆ Backlog åï¼Œå°† Backlog å†™å…¥é¡¹ç›®ç›®å½•
        å¹¶è®°å½•æ—¥å¿—
      action: |
        import os
        import re
        from datetime import datetime

        workspace = os.environ.get("OPENCLAW_WORKSPACE", "~/openclaw_workspace")
        workspace = os.path.expanduser(workspace)

        prd_meta = input_artifacts.get("PRD", {}).get("meta", {})
        project_name = prd_meta.get("Project Name", None)
        if not project_name:
            project_name = "default_project"

        safe_title = re.sub(r'[\\/:*?"<>| ]', '_', project_name.strip())
        base_folder_name = f"project-{safe_title}"
        project_path = os.path.join(workspace, base_folder_name)

        # æ”¯æŒå¸¦åºå·çš„é¡¹ç›®è·¯å¾„
        counter = 1
        final_path = context.get("project_path", project_path)
        while not os.path.exists(final_path) and counter < 20:
            counter += 1
            final_path = f"{project_path}-{counter}"

        backlog_content = output_artifacts.get("Backlog", {}).get("content", "")
        backlog_file_name = "project_backlog.md"
        backlog_file_path = os.path.join(final_path, backlog_file_name)

        with open(backlog_file_path, "w", encoding="utf-8") as f:
            f.write(backlog_content)

        # å†™æ—¥å¿—
        log_file = os.path.join(workspace, "project_creation.log")
        with open(log_file, "a", encoding="utf-8") as log:
            log.write(f"{datetime.now().strftime('%Y-%m-%d %H:%M:%S')} | Backlog å·²ç”Ÿæˆ: {backlog_file_path}\n")

        print(f"ğŸ“„ Backlog æ–‡ä»¶å·²ç”Ÿæˆ: {backlog_file_path}")
