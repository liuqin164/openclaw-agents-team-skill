agent: BackendEngineer
role: Backend Engineer
stage: Implementation

input:
  - APISpec
  - DBSchema

output:
  - BackendImplementation

prompt: |
  ä½ æ˜¯ä¸€ååç«¯å·¥ç¨‹å¸ˆã€‚
  ä½ çš„ä»»åŠ¡æ˜¯æ ¹æ® APISpec å’Œ DBSchema å®Œæˆåç«¯å®ç°æ–‡æ¡£ï¼ˆBackendImplementationï¼‰ã€‚
  è¾“å‡ºå¿…é¡»æ¸…æ™°ã€å¯äº¤ä»˜ï¼Œä¸æ¶‰åŠå‰ç«¯å®ç°ã€‚

rules:
  - ä¸ä¿®æ”¹ APISpec æˆ– DBSchema
  - ä¸è®¾è®¡å‰ç«¯é€»è¾‘
  - åªè¾“å‡ºå¯äº¤ä»˜æ–‡æ¡£ï¼Œä¸ç”Ÿæˆå®é™…ä»£ç 

constraints:
  - output_format: markdown

hooks:
  after_stage:
    - name: generate_backend_implementation
      description: >
        å°† BackendImplementation æ–‡ä»¶å†™å…¥é¡¹ç›®ç›®å½•ï¼Œå¹¶è®°å½•æ—¥å¿—
      action: |
        import os
        import re
        from datetime import datetime

        workspace = os.environ.get("OPENCLAW_WORKSPACE", "~/openclaw_workspace")
        workspace = os.path.expanduser(workspace)

        # é¡¹ç›®ç›®å½•è¯†åˆ«
        prd_meta = input_artifacts.get("PRD", {}).get("meta", {})
        project_name = prd_meta.get("Project Name", "default_project")
        safe_title = re.sub(r'[\\/:*?"<>| ]', '_', project_name.strip())
        project_path = os.path.join(workspace, f"project-{safe_title}")
        counter = 1
        final_path = project_path
        while not os.path.exists(final_path):
            counter += 1
            final_path = f"{project_path}-{counter}"

        # å†™ BackendImplementation
        content = output_artifacts.get("BackendImplementation", {}).get("content", "")
        file_name = "backend_implementation.md"
        file_path = os.path.join(final_path, file_name)
        with open(file_path, "w", encoding="utf-8") as f:
            f.write(content)

        # å†™æ—¥å¿—
        log_file = os.path.join(workspace, "project_creation.log")
        with open(log_file, "a", encoding="utf-8") as log:
            log.write(f"{datetime.now().strftime('%Y-%m-%d %H:%M:%S')} | BackendImplementation å·²ç”Ÿæˆ: {file_path}\n")

        print(f"ğŸ“„ BackendImplementation æ–‡ä»¶å·²ç”Ÿæˆ: {file_path}")
